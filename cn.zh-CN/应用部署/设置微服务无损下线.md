---
keyword: [优雅下线, 无损下线, 微服务应用]
---

# 设置微服务无损下线

如果您期望托管至SAE的微服务应用处理完请求后再停止应用，您可以使用SAE无损下线功能。SAE支持Spring Cloud和Dubbo应用无损下线。本文介绍如何在SAE控制台上配置无损下线。

## 应用部署时设置微服务无损下线

1.  登录[SAE控制台](https://sae.console.aliyun.com)。

2.  在左侧导航栏单击**应用列表**，在**应用列表**页面上方选择**地域**，单击**创建应用**。

3.  在**应用基本信息**页签，设置应用相关信息，配置完成后单击**下一步：应用部署配置**。

    ![Application_deployment_basic_information](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1369788951/p60491.png)

    参数说明如下表所示。

    |参数名|说明|
    |---|--|
    |应用名称|输入应用名称。允许数字、字母、下划线（\_）以及短划线（-）组合，仅允许字母开头，最大长度36个字符。|
    |专有网络配置|选择专有网络的配置方式。    -   **自定义配置**：选中后，您可以为创建的应用选择所需的命名空间、VPC、VSwitch及安全组。
    -   **自动配置**：选中后，SAE将自动帮您配置命名空间、VPC、VSwitch及安全组，无需手动选择。 |
    |命名空间|在下拉菜单中选择创建好的命名空间。仅**自定义配置**专有网络时需要选择。**说明：** 命名空间和VPC是一一映射关系，如果需要修改VPC请单击**命名空间详情页**，在**命名空间详情**页面单击**切换VPC**修改VPC信息。 |
    |VSwitch|在下拉菜单中选择VSwitch。仅**自定义配置**专有网络时需要选择。VSwitch数量至少需要配置一个，建议不超过3个，且每个VSwitch至少匹配一个应用实例。 |
    |安全组|在下拉菜单中选择安全组。仅**自定义配置**专有网络时需要选择。**说明：** 如果您的VPC内没有创建安全组，请单击**创建安全组**，根据提示创建安全组，详细说明请参见[创建安全组](/cn.zh-CN/安全/安全组/创建安全组.md)。 |
    |应用实例数|选择需要创建的实例个数。|
    |VCPU|选择需要创建的实例CPU规格。|
    |内存|选择需要创建的实例内存规格。|
    |应用描述|填写应用的基本情况，输入的描述信息不超过100个字符。|

4.  在**应用部署配置**页签，配置相关参数。

    参数说明如下表所示。

    |参数名|说明|
    |---|--|
    |技术栈语言|SAE支持**Java**、**PHP**及**其他语言**。|
    |应用部署方式|Java应用支持以下部署方式：    -   **镜像**
    -   **WAR包部署**
    -   **JAR包部署** |
    |应用运行环境|    -   **apache-tomcat-XXX**：适用于Spring Boot或Dubbo应用。
    -   **EDAS-Container-XXX**：适用于HSF应用。 |
    |Java环境|您可以根据需要选择Java环境：    -   **openjdk-XXXXX-jdk-alpine3.9**：基于Alphine操作系统，基础镜像小，实例交互速度快。
    -   **Open JDK X**：基于CentOS操作系统，基础镜像大，实例交互速度慢。
    -   **Dragonwell X**：支持最新OpenJDK 8版本，支持应用启动及运行时加速，提升GC效率等。更多信息，请参见[设置启动命令](/cn.zh-CN/应用部署/设置启动命令.md)。
**说明：** 基于Alphine操作系统的Java环境附带的工具或命令少于基于CentOS操作系统的Java环境，如果您选择了**openjdk-XXXXX-jdk-alpine3.9**，可能会导致Webshell中部分命令无法执行，请根据实际情况选择环境。 |
    |文件上传方式|可选择**上传WAR包**或**WAR包地址**。    -   **上传WAR包**：单击**选择文件**，选择待部署WAR包。
    -   **WAR包地址**：输入WAR包的存放地址。

**说明：** 应用部署程序包名仅允许字母、数字，及短划线（-）、下划线（\_）两个特殊符号。 |
    |版本|设置应用版本号，您可以选择输入版本号或者单击**使用时间戳为版本号**将时间戳作为应用版本号。|
    |时区设置|选择当前应用所在时区，例如**UTC+8**。|

5.  展开**微服务无损下线配置**区域，单击**微服务无损下线配置向导**。

    ![微服务无损下线配置向导](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1464736061/p185270.png)

6.  在**微服务无损下线配置向导**面板，设置相关参数，单击**预览配置**。

    ![微服务无损下线](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5287796061/p185291.png)

    参数说明如下。

    |变量名称|参数说明|
    |----|----|
    |是否开启优雅下线服务治理能力|默认为**true**。取值说明如下：    -   **true**：开启。
    -   **false**：关闭。 |
    |SAE优雅下线功能占用端口|默认端口为**54199**。如果此默认端口和您应用的端口产生冲突，请配置新的端口。|
    |收到Spring的ContextClosedEvent事件后，进程动态等待关闭的时间|默认取值为**5000**，即进程收到kill信号后，会等待5000 ms再关闭。配置该参数后，需要设置是否开启自动等待功能参数为**false**。 |
    |是否开启自动等待功能|默认为**true**。取值说明如下：    -   **true**：开启。进程可能会随着流量停止而提前关闭。
    -   **false**：关闭。进程直接等待收到Spring的ContextClosedEvent事件后，进程动态等待关闭的时间所配置的值的对应时长后再关闭。 |

7.  在**应用生命周期管理设置**区域，确认相关配置，单击**确认**。

    ![确认无损下线配置](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1464736061/p185304.png)

8.  单击**下一步：确认规格**。

9.  在**确认规格**页签，查看您所创建应用的详细信息以及配置费用情况，并单击**确认创建**。


## 应用部署完成后设置微服务无损下线

1.  登录[SAE控制台](https://sae.console.aliyun.com)。

2.  在左侧导航栏单击**应用列表**，在**应用列表**页面上方选择**地域**，单击具体应用名称。

3.  在**应用详情**页面的右上角，单击**部署应用**。

4.  在**部署应用**页面，展开**微服务无损下线配置**区域，单击**微服务无损下线配置向导**。

    ![微服务无损下线配置向导](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1464736061/p185270.png)

5.  在**微服务无损下线配置向导**面板，设置相关参数，单击**预览配置**。

    ![微服务无损下线](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5287796061/p185291.png)

    参数说明如下。

    |变量名称|参数说明|
    |----|----|
    |是否开启优雅下线服务治理能力|默认为**true**。取值说明如下：    -   **true**：开启。
    -   **false**：关闭。 |
    |SAE优雅下线功能占用端口|默认端口为**54199**。如果此默认端口和您应用的端口产生冲突，请配置新的端口。|
    |收到Spring的ContextClosedEvent事件后，进程动态等待关闭的时间|默认取值为**5000**，即进程收到kill信号后，会等待5000 ms再关闭。配置该参数后，需要设置是否开启自动等待功能参数为**false**。 |
    |是否开启自动等待功能|默认为**true**。取值说明如下：    -   **true**：开启。进程可能会随着流量停止而提前关闭。
    -   **false**：关闭。进程直接等待收到Spring的ContextClosedEvent事件后，进程动态等待关闭的时间所配置的值的对应时长后再关闭。 |

6.  在**应用生命周期管理设置**区域，确认相关配置，单击**确认**。

    ![确认无损下线配置](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1464736061/p185304.png)

7.  配置完成后单击**确认**。

    **说明：** 单击**确认**后，该应用将会被重启，请在业务较少的时间段进行。


