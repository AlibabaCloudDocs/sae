# 灰度发布或分批发布

如果您的应用有多个应用实例且需要升级，那么您可以按需通过灰度或分批发布方式升级应用实例版本。本文介绍两种发布方式的背景信息、场景示例和操作步骤；此外，还涉及应用回滚的说明。

## 背景信息

-   灰度发布：又名金丝雀发布，在原有部署版本可用的情况下，同时部署新版本应用作为金丝雀，测试新版本的性能，在保证整体系统稳定的情况下，帮助您尽早发现问题和修复问题。

    应用进行灰度发布时，为了保证应用稳定性，灰度发布的应用实例数不能超过应用实例总数的50%，剩余的应用实例按照指定的批次分批发布。

-   分批发布：按批次进行应用部署，每次仅对应用的一部分实例进行升级。分批发布过程中如果出现故障，则可以及时终止并回退，待问题修复后重新发布。

    应用进行分批发布时，应用内的实例数会平均分配到每个批次进行部署。如果无法平均分配，则靠前的批次分配到的实例数少，靠后的批次分配到的实例数多。


## 场景示例

某应用包含10个应用实例，每个应用实例的部署版本为Ver.1版本，现需将每个应用实例升级为Ver.2版本。

-   **灰度发布**：假设选择2台应用实例进行灰度发布，剩下8台应用实例分3批进行分批发布，发布流程如下图所示。

    ![灰度发布](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4760700061/p166205.png)

-   **分批发布**：假设将所有应用实例分3批进行部署，该发布流程如下图所示。

    ![分批发布流程](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4760700061/p166206.png)


## 操作步骤

1.  登录[SAE控制台](https://sae.console.aliyun.com)。

2.  在左侧导航栏单击**应用列表**，在**应用列表**页面上方选择**地域**，单击具体应用名称。

3.  在**应用详情**页面右上角单击**部署应用**。

4.  配置部署参数。

    **说明：** 部署方式由应用首次部署方式决定，请根据所需的部署方式设置参数。

    -   WAR包部署：重新上传WAR包或者输入新部署WAR包的地址，并完成相关环境和参数设置。

        ![应用部署_配置war包](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4760700061/p56826.png)

    -   JAR包部署：重新上传JAR包或者输入新部署JAR包的地址，并完成相关环境和参数设置。

        ![配置JAR包](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4760700061/p166222.png)

    -   镜像：在**部署应用**区域单击**修改镜像**，在**修改镜像**面板重新选择镜像仓库或镜像版本。

        ![修改应用镜像](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4760700061/p166217.png)

5.  您可以根据需要在**发布策略设置**区域内配置灰度发布或分批发布。

    -   灰度发布

        ![灰度发策略](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5783530261/p58239.png)

        灰度发布参数说明如下。

        |配置|是否必选|说明|
        |--|----|--|
        |发布策略|是|选择**灰度发布**。|
        |灰度数量|是|设置首先需要进行灰度发布的应用实例数量。|
        |灰度后剩余批次|是|灰度发布后，剩余的应用实例按照设定的批次完成发布。|
        |最小存活实例数|是|每次滚动升级最小存活的实例数。选择**使用系统推荐值**后SAE将根据您的需求为应用设置最佳的最小存活实例数。|
        |启用微服务灰度规则|否|您为Spring Cloud或Dubbo应用创建的灰度规则。具体操作，请参见[管理灰度规则（Java）](/cn.zh-CN/应用部署/控制台部署/管理灰度规则（Java）.md)。|

    -   分批发布

        ![分批发布策略设置 ](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4760700061/p58242.png)

        分批发布参数说明如下。

        |配置|是否必选|说明|
        |--|----|--|
        |发布策略|是|选择**分批发布**。|
        |发布批次|是|设置应用实例发布的批次。|
        |批次内部署间隔|是|每一批内，如果应用实例数大于1，应用实例间的部署时间间隔。|
        |最小存活实例数|是|每次滚动升级最小存活的实例数。选择**使用系统推荐值**后SAE将根据您的需求为应用设置最佳的最小存活实例数。|

6.  高级配置。

    |高级设置|是否必选|参考文档|
    |----|----|----|
    |设置PHP应用监控|否|[设置PHP应用监控](/cn.zh-CN/应用部署/设置PHP应用监控.md)**说明：** 仅**技术栈语言**为**PHP**时可以设置。 |
    |设置PHP应用配置文件|否|[设置PHP应用配置文件](/cn.zh-CN/应用部署/设置PHP应用配置文件.md)**说明：** 仅**技术栈语言**为**PHP**时可以设置。 |
    |启动命令|否|[设置启动命令](/cn.zh-CN/应用部署/设置启动命令.md)|
    |环境变量|否|[设置环境变量](/cn.zh-CN/应用部署/设置环境变量.md)|
    |Hosts绑定|否|[设置Hosts绑定](/cn.zh-CN/应用部署/设置Hosts绑定.md)|
    |应用健康检查|否|[设置健康检查](/cn.zh-CN/应用部署/设置健康检查.md)|
    |应用生命周期管理|否|[设置应用生命周期管理](/cn.zh-CN/应用部署/设置应用生命周期管理.md)|
    |日志收集|否|[设置日志收集](/cn.zh-CN/应用部署/设置日志收集.md)|
    |持久化存储|否|[设置NAS存储](/cn.zh-CN/应用部署/设置NAS存储.md)|
    |配置管理|否|[注入配置信息](/cn.zh-CN/应用部署/注入配置信息.md)|

7.  单击**确认**完成发布设置。

8.  您可以选择以下任一方式验证发布结果。

    -   方法一：在应用的**变更记录**页面中查看应用变更详情，查看发布状态，如果所有批次都执行成功，则说明应用更新成功。
    -   方法二：在应用**基本信息**页面的**实例部署信息**页签查看实例的运行状态。如果**执行状态**显示为**Running**，且实例的版本已变为Ver.2，表示应用部署成功。

## 应用回滚

采用灰度发布或者分批发布方式升级应用实例时，如果应用实例中存在未完成升级的实例，则当前应用升级状态处于**进行中**。

在实时跟踪应用升级时，如果首批应用实例升级突发异常停止响应，为了保证业务不受影响，请在**变更详情**页面中单击**立即回滚**，将已升级的实例回退至升级前版本，并将配置还原为升级前原有配置。

在应用变更过程中，如果出现部署包不可用、健康检查失败等变更流程异常情况，将导致应用升级失败，SAE将停止当前应用并进行回退。

在SAE上进行应用升级耗时约为30分钟，超出该时间后SAE将上报超时异常并暂停变更流程，请在**变更详情**页面手动终止发布流程并回滚应用。

## 更多信息

-   您在SAE部署完应用后，可以对应用进行更新、扩缩容、启停、删除应用等生命周期管理操作。具体操作，请参见[管理应用生命周期](/cn.zh-CN/应用管理/应用生命周期/管理应用生命周期.md)。
-   您在SAE部署完应用后，可以对应用进行自动弹性伸缩、SLB绑定和批量启停等提升应用性能的操作。具体操作，请参见以下文档：
    -   [绑定SLB](/cn.zh-CN/应用管理/绑定SLB/为应用绑定SLB.md)
    -   [配置弹性伸缩策略](/cn.zh-CN/应用管理/应用实例/配置弹性伸缩策略.md)
    -   [一键启停应用](/cn.zh-CN/应用管理/应用生命周期/一键启停应用.md)
    -   [配置管理](/cn.zh-CN/应用管理/ACM配置管理/配置管理概述.md)
    -   [变更实例规格](/cn.zh-CN/应用管理/应用实例/变更实例规格.md)
-   您在SAE部署完应用后，还可以对应用进行日志管理、监控管理、应用事件查看和变更记录查看等聚焦应用运行状态的操作。具体操作，请参见以下文档：
    -   [日志管理](/cn.zh-CN/应用管理/日志管理/查看实时日志.md)
    -   [监控管理](/cn.zh-CN/监控与报警/监控/基础监控.md)
    -   [应用事件查看](/cn.zh-CN/应用管理/应用变更记录/查看应用事件.md)
    -   [变更记录查看](/cn.zh-CN/应用管理/应用变更记录/查看变更记录.md)
    -   [使用Webshell诊断应用](/cn.zh-CN/应用管理/使用Webshell诊断应用.md)

## 问题反馈

如果您在使用SAE过程中有任何疑问，欢迎您扫描下面的二维码或搜索钉钉群号23198618，加入钉钉群与我们交流。

![SAE钉钉群2](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1176199061/p72048.png)

