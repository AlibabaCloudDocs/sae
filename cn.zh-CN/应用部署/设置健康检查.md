# 设置健康检查

将应用部署在SAE后，您可以使用健康检查功能查看容器与业务运行是否正常，以便异常时定位问题。

健康检查是指由Liveness探针或者Readiness探针对容器与应用进行定时检查，并将结果反馈给SAE控制台的过程，帮助您了解集群环境下整个服务的运行状态，方便定位问题。

SAE基于Kubernetes，提供了以下两种健康检查方式：

-   **应用实例存活检查（Liveness配置）**：针对单个应用实例进行健康检查，检测应用实例是否已经启动，如果已启动表示容器存活，反之亦然。如果检查到的容器存活状态为失败，SAE重启容器。如果容器存活检查成功，表示应用运作正常，不执行任何操作。
-   **应用业务就绪检查（Readiness配置）**：针对应用业务进行健康检查，检测处理客户请求的容器是否已经就绪。如果检测到容器未准备就绪，则上报容器异常，不为该容器分配业务流量；如果容器准备就绪，则分配业务流量进行处理。

    **说明：** 此方式适用于以下业务：

    -   启动时需要加载磁盘数据的业务。
    -   依赖外部模块而导致启动时间长的业务。

## 在创建应用过程中配置健康检查

1.  登录[SAE控制台](https://sae.console.aliyun.com)。

2.  在左侧导航栏单击**应用列表**，在**应用列表**页面上方选择**地域**，单击**创建应用**。

3.  在**应用基本信息**页签设置应用相关信息，并单击**下一步：应用部署配置**。

4.  在**应用部署配置**页签，选择**技术栈语言**和**应用部署方式**，设置部署参数。

5.  在**应用部署配置**页签，展开**应用健康检查设置**区域，并设置相关配置。

    **说明：**

    -   应用实例存活检查和应用业务就绪检查的参数相同。
    -   在健康检查设置中**应用实例存活检查（Liveness配置）**与**应用业务就绪检查（Readiness配置）**二者可选配其一，也可二者都配。如果二者都配，SAE优先进行应用实例存活检查，检查完成后再进行应用业务就绪检查。
    ![ex_readiness_config.png ](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0469788951/p107823.png)

    健康检查的参数说明如下所示。

    |参数名|说明|
    |---|--|
    |延迟时间|输入延迟检测时间。例如设置为10，表示从应用启动后10秒开始检测。|
    |超时时间|设置健康检查超时等待时间。例如设置为10，如果超时等待时间超过10秒，则本次健康检查失败，上报超时异常。若设置为0或不设置，默认超时等待时间为1秒。|
    |执行命令|设置容器或者进程内部执行的健康检查命令。如果该命令退出状态码为0，则表示容器健康。 命令格式请参见右侧的示例区域。

**说明：** 健康检查相关命令请参见Kubernetes官网[Configure Probes](https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#configure-probes)内容。 |

    -   示例一

        如果业务健康检查状态是根据/tmp/check.txt文件是否存在来判断的，那么可以使用命令`cat /tmp/check.txt`进行健康检查。

        ![应用健康检查示例1](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0469788951/p131596.png)

    -   示例二

        如果业务健康检查状态是通过HTTP方式访问127.0.0.1:8080路径来判断的，那么可以使用以下配置进行健康检查。

        ```
        bash
        -c 
        resp=$(curl -I -m 5 -o /dev/null -s -w %{http_code} 127.0.0.1:8080); if test "$resp" -ge 200 && test "$resp" -le 299; then exit 0; else exit 1; fi
        ```

        该配置通过curl命令获取127.0.0.1:8080网址的HTTP状态码并判断其是否在200～299范围内，若在范围内，则exit code为0，表示访问成功，否则为1，表示访问不成功。

        ![ex_readiness_config.png](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0469788951/p107823.png)

        **说明：** 若采用镜像部署，请确保镜像中包含相关命令且路径正确。若采用WAR或JAR包部署，请确保Java环境不是Alpine。

6.  单击**下一步：确认规格**。

7.  在**确认规格**页签，查看您所创建应用的详细信息以及配置费用情况，并单击**确认创建**。

8.  结果验证。

    1.  在应用详情页面的左侧导航栏中，单击**应用事件**。

    2.  检查是否存在健康检查Warning事件。

        -   如果存在，则表示健康检查配置失败。

            ![配置失败结果示意图](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0469788951/p71411.png)

        -   如果不存在，则表示配置成功。

## 应用部署完成后配置健康检查

健康检查配置可以在创建应用过程中设置，也可以在应用部署完成后进行配置。

1.  登录[SAE控制台](https://sae.console.aliyun.com)。

2.  在左侧导航栏单击**应用列表**，在**应用列表**页面上方选择**地域**，单击具体应用名称。

3.  在应用详情页面的右上角，单击**部署应用**。

4.  在**部署应用**页面，展开**应用健康检查设置**区域，配置相关参数。

    **说明：**

    -   应用实例存活检查和应用业务就绪检查的参数相同。
    -   在健康检查设置中**应用实例存活检查（Liveness配置）**与**应用业务就绪检查（Readiness配置）**二者可选配其一，也可二者都配。如果二者都配，SAE优先进行应用实例存活检查，检查完成后再进行应用业务就绪检查。
    ![ex_readiness_config.png ](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0469788951/p107823.png)

    健康检查的参数说明如下所示。

    |参数名|说明|
    |---|--|
    |延迟时间|输入延迟检测时间。例如设置为10，表示从应用启动后10秒开始检测。|
    |超时时间|设置健康检查超时等待时间。例如设置为10，如果超时等待时间超过10秒，则本次健康检查失败，上报超时异常。若设置为0或不设置，默认超时等待时间为1秒。|
    |执行命令|设置容器或者进程内部执行的健康检查命令。如果该命令退出状态码为0，则表示容器健康。 命令格式请参见右侧的示例区域。

**说明：** 健康检查相关命令请参见Kubernetes官网[Configure Probes](https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#configure-probes)内容。 |

    -   示例一

        如果业务健康检查状态是根据/tmp/check.txt文件是否存在来判断的，那么可以使用命令`cat /tmp/check.txt`进行健康检查。

        ![应用健康检查示例1](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0469788951/p131596.png)

    -   示例二

        如果业务健康检查状态是通过HTTP方式访问127.0.0.1:8080路径来判断的，那么可以使用以下配置进行健康检查。

        ```
        bash
        -c 
        resp=$(curl -I -m 5 -o /dev/null -s -w %{http_code} 127.0.0.1:8080); if test "$resp" -ge 200 && test "$resp" -le 299; then exit 0; else exit 1; fi
        ```

        该配置通过curl命令获取127.0.0.1:8080网址的HTTP状态码并判断其是否在200～299范围内，若在范围内，则exit code为0，表示访问成功，否则为1，表示访问不成功。

        ![ex_readiness_config.png](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0469788951/p107823.png)

        **说明：** 若采用镜像部署，请确保镜像中包含相关命令且路径正确。若采用WAR或JAR包部署，请确保Java环境不是Alpine。

5.  配置完成后单击**确认**。

    **说明：** 单击**确认**后，该应用将会被重启，请在业务较少的时间段进行。

6.  结果验证。

    1.  在应用详情页面的左侧导航栏中，单击**应用事件**。

    2.  检查是否存在健康检查Warning事件。

        -   如果存在，则表示健康检查配置失败。

            ![配置失败结果示意图](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0469788951/p71411.png)

        -   如果不存在，则表示配置成功。

## 问题反馈

如果您在使用SAE过程中有任何疑问，欢迎您扫描下面的二维码或搜索群号23198618，加入钉钉群与我们交流。

![SAE钉钉群2](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4279867061/p72048.png)

